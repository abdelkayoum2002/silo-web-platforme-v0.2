<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Load main.js and other necessary scripts -->
  <script src="/socket.io/socket.io.js"></script>
  <script type="module" src="main.js" defer></script>

  <title>Dashboard</title>
</head>
<body>
  <div class="dashboard">
    <h2>IoT Monitoring Dashboard</h2>

    <div class="indicator">
      <span class="label">Temperature LED:</span>
      <input type="checkbox" id="tempCheck" onchange="toggleLED('tempLED', this)">
      <span id="tempLED" class="led off"></span>
    </div>

    <div class="indicator">
      <span class="label">Humidity LED:</span>
      <input type="checkbox" id="humidityCheck" onchange="toggleLED('humidityLED', this)">
      <span id="humidityLED" class="led off"></span>
    </div>

    <button class="btn-stop" onclick="emergencyStop()">EMERGENCY STOP</button>

    <h2>MQTT Publisher</h2>
    <div class="mqtt">
      <label for="topic">Topic</label>
      <input list="options" id="topic" />
      <datalist id="options">
        <option value="sensor/temperature">
        <option value="sensor/humidity">
        <option value="system/emergency">
      </datalist>

      <label for="message">Message</label>
      <input type="text" id="message">

      <label for="qos">QoS</label>
      <select id="qos">
        <option value="0">0 - At most once</option>
        <option value="1">1 - At least once</option>
        <option value="2">2 - Exactly once</option>
      </select>

      <label>
        <input type="checkbox" id="retain"> Retain
      </label>

      <button id="publishBtn" onclick="publishMessage()">Publish</button>
      <div id="notification">Message Published Successfully!</div>
    </div>
  </div>

  <script>
    // Event listener for the DOMContentLoaded event
    document.addEventListener('DOMContentLoaded', () => {
      socket.on('topics', (data) => {
        refrecheTopics();
    });

      // Publish button event
      const publishBtn = document.getElementById("publishBtn");
      publishBtn.addEventListener('click', () => {
        const topic = document.getElementById('topic').value || undefined;
        const message = document.getElementById('message').value;
        const qos = parseInt(document.getElementById('qos').value);
        const retain = document.getElementById('retain').checked;
        window.socket.emit('publish', { topic, message, qos, retain });
      });
      function refrecheTopics(){
        if (window.topics?.Others) {
          console.log("Window topics:", window.topics.Others);
          const datalist = document.getElementById("options");
          // Populate the datalist with topics
          window.topics.Others.forEach(item => {
            const option = document.createElement("option");
            option.value =null;
            option.value = item.topic;
            datalist.appendChild(option);
          });
      }
    }
    });
  </script>
</body>
</html>
